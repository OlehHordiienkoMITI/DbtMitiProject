version: 2

semantic_models:
  - name: asian_covid_deaths
    model: ref('trf_asian')
    
    dimensions:
    - name: date_day
      expr: date_trunc('day', date)
      type: time
      type_params:
        time_granularity: day
    
    - name: date_month
      expr: date_trunc('month', date)
      type: time
      type_params:
        time_granularity: month

    - name: date_year
      expr: date_trunc('year', date)
      type: time
      type_params:
        time_granularity: year
    
    - name: is_deaths_abundant
      type: categorical
      expr: case when cases_asian > 50000 then true else false end
    
    - name: location
      type: categorical
      expr: state
    
    measures:
    - name: asian_deaths_total
      agg: sum
      expr: deaths_asian

    - name: asian_deaths_median
      agg: median
      expr: deaths_asian

    - name: asian_cases_average
      agg: average
      expr: cases_asian

metrics:
  # --- BASIC METRICS ---
  - name: asian_deaths_total
    label: "Total Asian Deaths"
    model: ref('trf_asian')
    calculation_method: sum
    expression: deaths_asian
    timestamp: date
    time_grains: [day, month, year]

  - name: asian_cases_total
    label: "Total Asian Cases"
    model: ref('trf_asian')
    calculation_method: sum
    expression: cases_asian
    timestamp: date
    time_grains: [day, month, year]

  - name: asian_cases_average
    label: "Average Asian Cases"
    model: ref('trf_asian')
    calculation_method: average
    expression: cases_asian
    timestamp: date
    time_grains: [day, month, year]

  - name: asian_deaths_median
    label: "Median Asian Deaths"
    model: ref('trf_asian')
    calculation_method: median
    expression: deaths_asian
    timestamp: date
    time_grains: [day, month, year]

  # --- DERIVED METRIC: CASE FATALITY RATE ---

  - name: case_fatality_rate
    label: "Case Fatality Rate"
    model: ref('trf_asian')
    calculation_method: expression
    expression: "sum(deaths_asian) / nullif(sum(cases_asian), 0)"
    timestamp: date
    time_grains: [day, month, year]

  # --- COMPARISON METRIC: DEATH CHANGE OVER TIME ---

  - name: deaths_day_over_day_change
    label: "Daily Change in Deaths"
    model: ref('trf_asian')
    calculation_method: difference
    expression: deaths_asian
    timestamp: date
    time_grains: [day]

  - name: cases_month_over_month_growth
    label: "Monthly Growth in Cases"
    model: ref('trf_asian')
    calculation_method: percent_change
    expression: cases_asian
    timestamp: date
    time_grains: [month]

  # --- FILTERED METRIC: HIGH DEATH DAYS ---

  - name: deaths_when_abundant
    label: "Deaths When Cases > 50k"
    model: ref('trf_asian')
    calculation_method: sum
    expression: deaths_asian
    timestamp: date
    time_grains: [day, month]
    filters:
      - field: cases_asian
        operator: ">"
        value: "50000"
